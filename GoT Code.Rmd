---
title: 'Game of Thrones: IMDb Scraping and Analysis'
author: "Patricia Tang"
date: "5/20/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Part 1: Scraping the Data

``` {r}
library(xml2)
library(rvest)
library(tm)
library(SnowballC)
library(broom)
library(tidytext)
library(ggplot2)
library(lubridate)
library(dplyr)
```

``` {r}
# from Napon - GENERAL information about episodes. no keywords, no directors, etc. 
get_info <- function(x){
  page <- read_html(paste0("https://www.imdb.com/title/tt0944947/episodes?season=",x))
  season <- x
  ep_title <- page %>% html_nodes("#episodes_content strong a") %>% html_text()
  ep_num <- page %>% html_nodes("#episodes_content strong a") %>% html_attr("href") %>% gsub(".*ep", "", .)
  text <- page %>% html_nodes(".item_description") %>% html_text() %>% gsub("\\n ", "", .)
  rating <- page %>% html_nodes(".ipl-rating-star.small .ipl-rating-star__rating") %>% html_text() %>% as.numeric()
  airdate <- page %>% html_nodes(".airdate") %>% html_text() %>% dmy()
  links <- page %>%
  html_nodes("#episodes_content strong a") %>%
  html_attr('href')
  return(data.frame(season, ep_title, ep_num, text, rating, airdate, links, stringsAsFactors = F))
}

Thrones <- lapply(1:8, get_info) %>% bind_rows()
```

``` {r}
# to get full links
for(i in 1:73){
  Thrones$links[i] <- paste("https://www.imdb.com", Thrones$links[i], sep ='')
}
```

``` {r}
# to get href links for keyword scraping
Thrones$keywordlinks <- substr(Thrones$links, start=1, stop=37)
```

``` {r}
# to make full links for all keyword links
for(i in 1:73){
  Thrones$keywordlinks[i] <- paste(Thrones$keywordlinks[i], "keywords?ref_=tt_stry_kw", sep ='') 
  # "keywords?ref_=tt_stry_kw" returns keyword page for ALL IMDb pages here
}
```

``` {r}
# to get keyword data
for(i in 1:73){
  link = as.character(Thrones$keywordlinks[i])
  Thrones$keywords[i] <- read_html(link) %>% html_nodes("div.sodatext") %>%
    html_text %>% paste(collapse = "\n\n")
}
```

``` {r}
# to get directors/writing credits
Thrones$creditlinks <- substr(Thrones$links, start=1, stop=37)
for(i in 1:73){
  Thrones$creditlinks[i] <- paste(Thrones$creditlinks[i], "fullcredits?ref_=tt_ov_wr", sep ='') 
  # "fullcredits?ref_=tt_ov_wr" returns keyword page for ALL IMDb pages here
}
```

``` {r}
# to get credit data
for(i in 1:73){
  link = as.character(Thrones$creditlinks[i])
  Thrones$credits[i] <- read_html(link) %>% html_nodes("#fullcredits_content a") %>%
    html_text %>% paste(collapse = "\n\n")
}
```

``` {r}
# to get directorial credit.
for(i in 1:73){
  link = as.character(Thrones$creditlinks[i])
  Thrones$director[i] <- read_html(link) %>% html_nodes(".simpleCreditsTable:nth-child(2)") %>%
    html_text %>% paste(collapse = "\n\n")
}

```

# Part 2: Prepping for Text Analysis

``` {r}
# DTM for keywords
ThronesCorpus <- VCorpus(VectorSource(Thrones$keywords)) %>% tm_map(removeWords, stopwords("english"))
KeywordDTM = DocumentTermMatrix(ThronesCorpus) 
KeywordDTMclean = KeywordDTM %>% tidy()
```

``` {r}
# DTM for text
TextCorpus <- VCorpus(VectorSource(Thrones$text)) %>% tm_map(removePunctuation) %>% tm_map(tolower) %>% tm_map(removeWords, stopwords("english")) %>% tm_map(PlainTextDocument)
TextDTM = DocumentTermMatrix(TextCorpus) 
TextDTM_copy = TextDTM %>% removeSparseTerms(.99)
TextDTMclean = TextDTM_copy %>% tidy()
tfidf <- TextDTMclean %>%bind_tf_idf(term,document, count)
```

# Part 3: Frequency Analysis

```{r}
# Keywords
Keyword_Matrix <-as.matrix(KeywordDTM)
freq <- sort(colSums(Keyword_Matrix), decreasing = TRUE)
freqdf <-as.data.frame(freq)
top <- head(freq, 20)

top_df <- data.frame(word = names(top), freq = top)
Keywordfreq <- ggplot(data=top_df, aes(x=reorder(word, -freq), y=freq)) + geom_bar(stat="identity") + xlab("Keywords") + ylab("Frequency") + theme(legend.title = element_text(size = 3), legend.text = element_text(size = 0.01), axis.text.x=element_text(angle=45,hjust=1,vjust=0.5)) + ggtitle("Most Frequent Game of Thrones Keywords")
Keywordfreq
```

``` {r}
# Synopsis
TextMatrix <-as.matrix(TextDTM)
freq2 <- sort(colSums(TextMatrix), decreasing = TRUE)
freqdf2 <-as.data.frame(freq2)
top2 <- head(freq2, 20)

top_df2 <- data.frame(word = names(top2), freq = top2)
Textfreq <- ggplot(data=top_df2, aes(x=reorder(word, -freq), y=freq)) + geom_bar(stat="identity") + xlab("Keywords") + ylab("Frequency") + theme(legend.title = element_text(size = 3), legend.text = element_text(size = 0.01), axis.text.x=element_text(angle=45,hjust=1,vjust=0.5)) + ggtitle("Most Frequent Game of Thrones Synopsis Keywords")
Textfreq
```

``` {r}
# Ratings by director 
library(plyr)
library(stringr)
perdirect <- ddply(Thrones, .(director), summarize,  rating=mean(rating))
perdirect$director <- sapply(perdirect$director,
                                    function(x) { gsub("\n", "", x) })
perdirect$director <- sapply(perdirect$director,
                                    function(x) { gsub("[\r\n]", "", x) })
perdirect$director <- sapply(perdirect$director,
                                    function(x) { gsub(" ", "", x) })
perdirect$director <- sapply(perdirect$director,
                                    function(x) {gsub("([[:lower:]])(?=[[:upper:]])", "\\1 ", x, perl = TRUE)})
perdirect
```

``` {r}
Directrat <- ggplot(data=perdirect, aes(x=reorder(director, rating), y=rating)) + geom_bar(stat="identity") + xlab("Director") + ylab("Episode Rating (out of 10)") + theme(legend.title = element_text(size = 3), legend.text = element_text(size = 0.1), axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) + ggtitle("Episode Rating, By Director(s)") + coord_flip()
Directrat
```

Clearly, we can see that Benioff and Weiss' individually-directed episodes are much lower in quality than those with other uncredited directorial personnel. We also note that episodes with D.B. Weiss credited first (before Benioff) are also slightly higher in rating. 

Neil Marshall, Alex Graves, and Matt Shakman clearly directed the highest-rated episodes. Come back to this later. 

``` {r}
Thrones$epnumeral <- c(1:73)
Bestepisodes <- ggplot(data=Thrones, aes(x=epnumeral, y=rating)) + geom_line() + geom_point() + ggtitle("GoT Episode Rating Over Time") + xlab("Episodes") + ylab("Rating") + theme(legend.title = element_text(size = 3), legend.text = element_text(size = 0.01))
Bestepisodes
```

# Part 4: "Character Studies"

``` {r}
# Does episode rating change if we have popular characters in them?
# Let's create indicator variables for whether or not popular characters appear. Key players as defined by prior frequency analysis in synopsis info: Jon, Daenerys, Tyrion, Arya, Sansa, Jaime, Cersei, Theon, Robb, Bran, Sam, Stannis. 
# (Too many characters, let's keep it simple!!)
```

``` {r}
# function for later
FUNction <- function(x) {
  c(min = min(x), max = max(x), 
    mean = mean(x), median = median(x), 
    std = sd(x))
}
```

``` {r}
Thrones$jon <- ifelse(str_detect(Thrones$text, "Jon") == "TRUE", "1", "0") 
tapply(Thrones$rating, Thrones$jon, FUNction)
cbind(Presence = unique(Thrones$jon), 
      do.call(rbind, tapply(Thrones$rating, Thrones$jon, FUNction)))
```

``` {r}
chisq.test(table(Thrones$rating, Thrones$jon))
```

``` {r}
Thrones$dany <- ifelse(str_detect(Thrones$text, "Daenerys") == "TRUE", "1", "0") 
tapply(Thrones$rating, Thrones$dany, FUNction)
cbind(Presence = unique(Thrones$dany), 
      do.call(rbind, tapply(Thrones$rating, Thrones$dany, FUNction)))
```

``` {r}
chisq.test(table(Thrones$rating, Thrones$dany))
```

``` {r}
Thrones$tyrion <- ifelse(str_detect(Thrones$text, "Tyrion") == "TRUE", "1", "0") 
tapply(Thrones$rating, Thrones$tyrion, FUNction)
cbind(Presence = unique(Thrones$tyrion), 
      do.call(rbind, tapply(Thrones$rating, Thrones$tyrion, FUNction)))
```

``` {r}
chisq.test(table(Thrones$rating, Thrones$tyrion))
```

``` {r}
Thrones$arya <- ifelse(str_detect(Thrones$text, "Arya") == "TRUE", "1", "0") 
tapply(Thrones$rating, Thrones$arya, FUNction)
cbind(Presence = unique(Thrones$arya), 
      do.call(rbind, tapply(Thrones$rating, Thrones$arya, FUNction)))
```

``` {r}
chisq.test(table(Thrones$rating, Thrones$arya))
```

``` {r}
Thrones$sansa <- ifelse(str_detect(Thrones$text, "Sansa") == "TRUE", "1", "0") 
tapply(Thrones$rating, Thrones$sansa, FUNction)
cbind(Presence = unique(Thrones$sansa), 
      do.call(rbind, tapply(Thrones$rating, Thrones$sansa, FUNction)))
```

``` {r}
chisq.test(table(Thrones$rating, Thrones$sansa))
```

``` {r}
Thrones$jaime <- ifelse(str_detect(Thrones$text, "Jaime") == "TRUE", "1", "0")
tapply(Thrones$rating, Thrones$jaime, FUNction)
cbind(Presence = unique(Thrones$jaime), 
      do.call(rbind, tapply(Thrones$rating, Thrones$jaime, FUNction)))
```

``` {r}
chisq.test(table(Thrones$rating, Thrones$jaime))
```

``` {r}
Thrones$cersei <- ifelse(str_detect(Thrones$text, "Cersei") == "TRUE", "1", "0")
tapply(Thrones$rating, Thrones$cersei, FUNction)
cbind(Presence = unique(Thrones$cersei), 
      do.call(rbind, tapply(Thrones$rating, Thrones$cersei, FUNction)))
```

``` {r}
chisq.test(table(Thrones$rating, Thrones$cersei))
```

``` {r}
Thrones$theon <- ifelse(str_detect(Thrones$text, "Theon") == "TRUE", "1", "0")
tapply(Thrones$rating, Thrones$theon, FUNction)
cbind(Presence = unique(Thrones$theon), 
      do.call(rbind, tapply(Thrones$rating, Thrones$theon, FUNction)))
```

``` {r}
chisq.test(table(Thrones$rating, Thrones$theon))
```

``` {r}
Thrones$robb <- ifelse(str_detect(Thrones$text, "Robb") == "TRUE", "1", "0")
tapply(Thrones$rating, Thrones$robb, FUNction)
cbind(Presence = unique(Thrones$robb), 
      do.call(rbind, tapply(Thrones$rating, Thrones$robb, FUNction)))
```

``` {r}
chisq.test(table(Thrones$rating, Thrones$robb))
```

``` {r}
Thrones$bran <- ifelse(str_detect(Thrones$text, "Bran") == "TRUE", "1", "0")
tapply(Thrones$rating, Thrones$bran, FUNction)
cbind(Presence = unique(Thrones$bran), 
      do.call(rbind, tapply(Thrones$rating, Thrones$bran, FUNction)))
```

``` {r}
chisq.test(table(Thrones$rating, Thrones$bran))
```

``` {r}
Thrones$sam <- ifelse(str_detect(Thrones$text, "Sam") == "TRUE", "1", "0")
tapply(Thrones$rating, Thrones$sam, FUNction)
cbind(Presence = unique(Thrones$sam), 
      do.call(rbind, tapply(Thrones$rating, Thrones$sam, FUNction)))
```

``` {r}
chisq.test(table(Thrones$rating, Thrones$sam))
```

``` {r}
Thrones$stannis <- ifelse(str_detect(Thrones$text, "Stannis") == "TRUE", "1", "0")
tapply(Thrones$rating, Thrones$stannis, FUNction)
cbind(Presence = unique(Thrones$stannis), 
      do.call(rbind, tapply(Thrones$rating, Thrones$stannis, FUNction)))
```

``` {r}
chisq.test(table(Thrones$rating, Thrones$sam))
```

``` {r}
# Creating an aggregate variable - character "score" (how many popular characters show up in a given episode's synopsis?)
# Jon, Daenerys, Tyrion, Arya, Sansa, Jaime, Cersei, Theon, Robb, Bran, Sam, Stannis
Thrones$jon <- as.numeric(Thrones$jon)
Thrones$dany <- as.numeric(Thrones$dany)
Thrones$tyrion <- as.numeric(Thrones$tyrion)
Thrones$arya <- as.numeric(Thrones$arya)
Thrones$sansa <- as.numeric(Thrones$sansa)
Thrones$jaime <- as.numeric(Thrones$jaime)
Thrones$cersei <- as.numeric(Thrones$cersei)
Thrones$theon <- as.numeric(Thrones$theon)
Thrones$robb <- as.numeric(Thrones$robb)
Thrones$bran <- as.numeric(Thrones$bran)
Thrones$sam <- as.numeric(Thrones$sam)
Thrones$stannis <- as.numeric(Thrones$stannis)
Thrones$charascore <- Thrones$jon + Thrones$dany + Thrones$tyrion + Thrones$arya + Thrones$sansa + Thrones$jaime + Thrones$cersei + Thrones$theon + Thrones$robb + Thrones$bran + Thrones$sam + Thrones$stannis
```

# Part 5: Topic Models

``` {r, results = "hide"}
# Keywords, new VCorpus (stemmed)
library(topicmodels)
library(stm)
KeyCorpus2 <- VCorpus(VectorSource(Thrones$keywords)) %>% tm_map(removePunctuation) %>% tm_map(tolower) %>% tm_map(removeWords, stopwords("english")) %>% tm_map(stemDocument) %>% tm_map(PlainTextDocument)
KeyDTM2 = DocumentTermMatrix(KeyCorpus2) 

out <- stm::readCorpus(KeyDTM2, type = 'slam')
mod.out <- stm(documents = out$documents,
               vocab = out$vocab,
               K = 3, 
               data = Thrones)
summary(mod.out)
```

``` {r, results = "hide"}
# Text, new VCorpus (stemmed)
TextCorpus2 <- VCorpus(VectorSource(Thrones$text)) %>% tm_map(removePunctuation) %>% tm_map(tolower) %>% tm_map(removeWords, stopwords("english")) %>% tm_map(stemDocument) %>% tm_map(PlainTextDocument)
TextDTM2 = DocumentTermMatrix(TextCorpus2) 

out2 <- stm::readCorpus(TextDTM2, type = 'slam')
mod.out2 <- stm(documents = out2$documents,
               vocab = out2$vocab,
               K = 4, 
               data = Thrones)
summary(mod.out2)
```

# Part 6: Regression Analysis

``` {r}
# A low-level example: does nudity affect rating?
library(stringr)
Thrones$ND <- ifelse(str_detect(Thrones$keywords, "nudity") == "TRUE", "1", "0") 
Thrones$ND <- as.numeric(Thrones$ND)
```

``` {r}
NDlinear <- lm(Thrones$rating ~ Thrones$ND, data = Thrones)
summary(NDlinear)
```

Relationship between nudity and Game of Thrones episode rating is not statistically significant. 

``` {r}
# What about violence?
library(stringr)
Thrones$violence <- ifelse(str_detect(Thrones$keywords, "violence") == "TRUE", "1", "0") 
Thrones$violence <- as.numeric(Thrones$violence)
```

``` {r}
Violencelinear <- lm(Thrones$rating ~ Thrones$violence, data = Thrones)
summary(Violencelinear)
```

Relationship between violence and Game of Thrones episode rating is not statistically significant. 

``` {r}
# Chara score 
Charalinear <- lm(Thrones$rating ~ Thrones$charascore, data = Thrones)
summary(Charalinear)
```

Statistically significant relationship between character score (as defined earlier) and rating. Thus, while individual characters did not seem to affect rating (as per chi-squared test), rating seems to be affected by the number of characters highlighted in a given episode. 

``` {r}
# To determine involvement of directors - dummy variables
```

``` {r}
# Determining if a departure from the books affects episode quality. 
# Using this article from 2015 (https://www.forbes.com/sites/insertcoin/2015/04/12/why-game-of-thrones-finally-outrunning-the-books-is-a-good-thing/#6bfc36c7524b) as an indicator for when Game of Thrones departed from the books. 
# Creating a dummy variable - all episodes after season 4 finale will be counted as "departed from the books" (1) otherwise (0)

```


